<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <style>
        html, body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0d1b2a 0%, #1e3a8a 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        body::-webkit-scrollbar { display: none; }

        header.futuristic-header {
            background-color: #1e1e2f;
            padding: 15px 0;
            color: #fff;
        }
        header .container { display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header h1 { color: #00d4ff; margin: 0; }
        header .nav-container { display: flex; align-items: center; gap: 30px; }
        header nav ul { list-style: none; display: flex; gap: 25px; margin: 0; padding: 0; }
        header nav ul li a { color: #fff; text-decoration: none; font-weight: 600; transition: color 0.3s; }
        header nav ul li a:hover { color: #00d4ff; }
        .profile-icon img { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }

        main.container {
            max-width: 1200px;
            margin: 40px auto 80px;
            background-color: rgba(30, 30, 47, 0.5);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            color: #fff;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        h2 { color: #00d4ff; text-align: center; margin-bottom: 30px; font-size: 1.8em; }

        .profile-picture {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #e2e8f0;
            background: #f7fafc;
            margin: 0 auto;
        }
        .profile-picture img { width: 100%; height: 100%; object-fit: cover; }
        .upload-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; cursor: pointer;
        }
        .profile-picture:hover .upload-overlay { opacity: 1; }
        .upload-overlay i { color: #fff; font-size: 1.5rem; }

        .edit-form { display: flex; flex-direction: column; gap: 15px; }
        .edit-form label { display: block; color: #00d4ff; font-weight: 600; margin-bottom: 5px; }
        .edit-form input, .edit-form textarea {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #444; background-color: #2a2a3f; color: #fff;
        }
        .edit-form textarea { resize: vertical; min-height: 80px; }

        .button-container { display: flex; gap: 10px; margin-top: 15px; }
        .button-container button, .button-container a {
            padding: 10px 20px; border-radius: 6px; border: 2px solid #00d4ff;
            background: transparent; color: #00d4ff; font-weight: 600; text-decoration: none; cursor: pointer;
            transition: all 0.3s;
        }
        footer.futuristic-footer { background-color: #1e1e2f; padding: 15px 0; color: #fff; text-align: center; }
        footer .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        .button-container button:hover, .button-container a:hover {
            background-color: rgba(0,212,255,0.1); color: #00bcd4; border-color: #00bcd4;
        }

        @media (max-width: 768px) { main.container { grid-template-columns: 1fr; } .profile-picture { width: 120px; height: 120px; } }
    </style>
</head>
<body>

<div id="header-placeholder"></div>

<main class="container">
    <div>
        <h2>Edit Profile</h2>
        <div class="profile-picture">
            <img id="profileImage" src="/images/default-profile.png" alt="Profile Picture"/>
            <div class="upload-overlay"><i class="fas fa-camera"></i></div>
            <input type="file" id="profilePictureUpload" accept="image/*" style="display: none;"/>
        </div>
    </div>

    <form class="edit-form" id="editProfileForm">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" required/>

        <label for="firstName">First Name</label>
        <input type="text" id="firstName" name="firstName"/>

        <label for="lastName">Last Name</label>
        <input type="text" id="lastName" name="lastName"/>

        <label for="email">Email</label>
        <input type="email" id="email" name="email" required/>

        <label for="birthDate">Date of Birth</label>
        <input type="date" id="birthDate" name="birthDate"/>

        <label for="phone">Phone Number</label>
        <input type="text" id="phone" name="phone"/>

        <label for="address">Address</label>
        <input type="text" id="address" name="address"/>

        <label for="medicalHistory">Medical History</label>
        <textarea id="medicalHistory" name="medicalHistory"></textarea>

        <label for="insuranceProvider">Insurance Provider</label>
        <input type="text" id="insuranceProvider" name="insuranceProvider"/>

        <div class="button-container">
            <button type="submit">Save Changes</button>
            <a id="cancelEdit" href="/user/profile.html">Cancel</a>
        </div>
    </form>
</main>
<div id="footer-placeholder"></div>

<script>

    async function loadHTML(id, url) {
       const res = await fetch(url);
       const html = await res.text();
       document.getElementById(id).innerHTML = html;
   }
   document.querySelector('.profile-picture').addEventListener('click', () => {
       document.getElementById('profilePictureUpload').click();
   });

   function getUserIdFromUrl() {
       const params = new URLSearchParams(window.location.search);
       return params.get("id");
   }

   document.addEventListener("DOMContentLoaded", async () => {
       const userId = getUserIdFromUrl() || 1;
       try {
           const res = await fetch(`/api/persons/${userId}`);
           if (!res.ok) throw new Error("Failed to fetch user data");
           const user = await res.json();

           document.getElementById("username").value = user.userName || "";
           document.getElementById("firstName").value = user.firstName || "";
           document.getElementById("lastName").value = user.lastName || "";
           document.getElementById("email").value = user.email || "";
           document.getElementById("birthDate").value = user.birthDate || "";
           document.getElementById("phone").value = user.phone || "";
           document.getElementById("address").value = user.address || "";
           document.getElementById("medicalHistory").value = user.medicalHistory || "";
           document.getElementById("insuranceProvider").value = user.insuranceProvider || "";
           if (user.profilePicture) document.getElementById("profileImage").src = user.profilePicture;
       } catch (err) {
           console.error(err);
           alert("Failed to load user data.");
       }
   });

   document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
       e.preventDefault();
       const userId = getUserIdFromUrl() || 1;
       const data = {
           username: document.getElementById("username").value,
           firstName: document.getElementById("firstName").value,
           lastName: document.getElementById("lastName").value,
           email: document.getElementById("email").value,
           dateOfBirth: document.getElementById("birthDate").value,
           phoneNumber: document.getElementById("phone").value,
           address: document.getElementById("address").value,
           medicalHistory: document.getElementById("medicalHistory").value,
           insuranceProvider: document.getElementById("insuranceProvider").value
       };
       try {
           const res = await fetch(`/api/persons/${userId}`, {
               method: "PUT",
               headers: { "Content-Type": "application/json" },
               body: JSON.stringify(data)
           });
           if (!res.ok) {
               const err = await res.text();
               throw new Error(err);
           }
           alert("Profile updated successfully!");
           window.location.href = `/user/profile.html?id=${userId}`;
       } catch (err) {
           console.error(err);
           alert("Failed to update profile: " + err.message);
       }
   });
     // Load header/footer first, then user data
    loadHTML('header-placeholder', '/components/header.html');
    loadHTML('footer-placeholder', '/components/footer.html');
</script>

</body>
</html>
