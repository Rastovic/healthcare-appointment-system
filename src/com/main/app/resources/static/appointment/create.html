<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Appointment</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
<!-- Header Component -->
<div id="header-placeholder"></div>

<main class="container">
    <h2>Create Appointment</h2>
    <div class="form-container">
        <form id="appointmentForm" action="/api/appointments/create" method="post">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" name="title" required />
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description"></textarea>
            </div>
            <div class="form-group">
                <label for="startTime">Start Time</label>
                <input type="datetime-local" id="startTime" name="startTime" required />
            </div>
            <div class="form-group">
                <label for="endTime">End Time</label>
                <input type="datetime-local" id="endTime" name="endTime" required />
            </div>
            <div class="form-group">
                <label for="doctorId">Doctor</label>
                <select id="doctorId" name="doctorId" required>
                    <option value="">Select a Doctor</option>
                </select>
            </div>
            <div class="form-group">
                <label for="location">Location</label>
                <input type="text" id="location" name="location" />
            </div>
            <input type="hidden" id="status" name="status" value="Scheduled" />
            <div class="button-container">
                <button type="submit" class="submit-button">Create Appointment</button>
                <button class="submit-button" href="/doctor/dashboard.html" >Back to Dashboard</button>
            </div>
        </form>
    </div>
</main>

<!-- Footer Component -->
<div id="footer-placeholder"></div>

<script>
    let personId = null;
    let userRole = null;

    async function loadCurrentUser() {
        try {
            const res = await fetch("/api/auth/me");
            if (!res.ok) throw new Error("Not authenticated");
            const data = await res.json();

            personId = data.id;
            userRole = data.roleName; // "ADMIN", "DOCTOR", "PATIENT"
            console.log("Logged in:", personId, userRole);

            // update dashboard link in header if present
            const dashboardLink = document.querySelector('#header-placeholder a#dashboardLink');
            if (dashboardLink) {
                if (userRole === "ADMIN") dashboardLink.href = "/admin/dashboard.html";
                else if (userRole === "DOCTOR") dashboardLink.href = "/doctor/dashboard.html";
                else if (userRole === "PATIENT") dashboardLink.href = "/patient/dashboard.html";
            }
        } catch (err) {
            console.error("Error fetching current user:", err);
            window.location.href = "/login";
        }
    }

    function redirectToDashboard(roleName) {
        if (roleName === "ADMIN") {
            window.location.href = "/admin/dashboard.html";
        } else if (roleName === "DOCTOR") {
            window.location.href = "/doctor/dashboard.html";
        } else if (roleName === "PATIENT") {
            window.location.href = "/patient/dashboard.html";
        } else {
            window.location.href = "/";
        }
    }

    async function loadHTML(id, url) {
        try {
            const res = await fetch(url);
            const html = await res.text();
            document.getElementById(id).innerHTML = html;
        } catch (err) {
            console.error(`Failed to load ${url}`, err);
        }
    }

    // Load header/footer first, then setup page
    loadHTML('header-placeholder', '/components/header.html').then(async () => {
        // Add Create Appointment link to nav dynamically
        const navList = document.querySelector('#header-placeholder nav ul');
        if (navList && !document.querySelector('#header-placeholder a[href="/appointment/create.html"]')) {
            const li = document.createElement('li');
            li.innerHTML = '<a href="/appointment/create.html">Create Appointment</a>';
            navList.appendChild(li);
        }

        // fetch current user info (sets personId + userRole)
        await loadCurrentUser();

        // Fetch doctors
        fetch('/api/persons/role/2')
            .then(response => response.json())
            .then(doctors => {
                const doctorSelect = document.getElementById('doctorId');
                doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = `${doctor.firstName} ${doctor.lastName}`;
                    doctorSelect.appendChild(option);
                });
            })
            .catch(err => console.error(err));

        // Submit form
        document.getElementById('appointmentForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const formData = new FormData(event.target);
            const appointmentData = {
                title: formData.get('title'),
                description: formData.get('description'),
                startTime: formData.get('startTime'),
                endTime: formData.get('endTime'),
                personId: personId,   // logged-in user id
                doctorId: parseInt(formData.get('doctorId')),
                location: formData.get('location'),
                status: formData.get('status')
            };

            console.log("Submitting appointment:", appointmentData);

            try {
                const response = await fetch(event.target.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appointmentData)
                });

                if (response.ok) {
                    redirectToDashboard(userRole);
                } else {
                    const errorText = await response.text();
                    alert('Failed to create appointment: ' + errorText);
                }
            } catch (error) {
                console.error('Error creating appointment:', error);
                alert('An error occurred while creating the appointment.');
            }
        });
    });

    loadHTML('footer-placeholder', '/components/footer.html');
</script>
</body>
</html>
